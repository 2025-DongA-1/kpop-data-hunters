<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>KPOP ì•„ì´ëŒ ë°ë·” ëŒ€ì‹œë³´ë“œ</title>
  <script src="https://cdn.amcharts.com/lib/5/index.js"></script>
  <script src="https://cdn.amcharts.com/lib/5/map.js"></script>
  <script src="https://cdn.amcharts.com/lib/5/geodata/worldLow.js"></script>
  <script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      margin: 0;
      font-family: "Noto Sans KR", sans-serif;
      background: #f5f6fa;
      display: flex;
      flex-direction: row;
      justify-content: center;
      align-items: flex-start;
      padding: 20px;
      gap: 20px;
    }

    #mapContainer {
      width: 1000px;
      height: 700px;
      border-radius: 20px;
      background: white;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      overflow: hidden;
    }

    #detail {
      width: 450px;
      height: 700px;
      background: white;
      border-radius: 20px;
      padding: 20px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: stretch;
    }

    #detail h2 {
      margin: 0 0 20px 0;
      text-align: center;
      color: #2f3640;
    }

    #lineChart {
      flex: 1;
    }

    .no-data {
      text-align: center;
      color: #aaa;
      margin-top: 100px;
      font-size: 1.1rem;
    }

    .footer-note {
      text-align: center;
      font-size: 0.8rem;
      color: #999;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div id="mapContainer"></div>
  <div id="detail">
    <h2 id="countryName">êµ­ê°€ë¥¼ ì„ íƒí•˜ì„¸ìš”</h2>
    <canvas id="lineChart"></canvas>
    <div id="noData" class="no-data" style="display:none;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>
    <div class="footer-note">Â© KPOP Dashboard</div>
  </div>

  <script>
    let debutData = {};
    let detailData = {};

    async function loadData() {
      try {
        // ğŸ§© ë°ìŠ¤í¬íƒ‘ ê²½ë¡œ ì˜ˆì‹œ (ê°™ì€ í´ë” or dataí´ë”ì— íŒŒì¼ ë‘ì„¸ìš”)
        // íŒŒì¼ ì˜ˆ: debut_data.json
        const response = await fetch("./");
        const json = await response.json();

        debutData = json.debut_summary; // {KR: 1200, JP: 300, ...}
        detailData = json.details;      // {KR: {...}, JP: {...}, ...}
        initMap();
      } catch (e) {
        console.error("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", e);
        alert("ë°ì´í„° íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê²½ë¡œë¥¼ í™•ì¸í•˜ì„¸ìš”.");
      }
    }

    function initMap() {
      am5.ready(function() {
        const root = am5.Root.new("mapContainer");
        root.setThemes([am5themes_Animated.new(root)]);

        const chart = root.container.children.push(
          am5map.MapChart.new(root, {
            projection: am5map.geoMercator()
          })
        );

        const polygonSeries = chart.series.push(
          am5map.MapPolygonSeries.new(root, {
            geoJSON: am5geodata_worldLow
          })
        );

        polygonSeries.mapPolygons.template.setAll({
          tooltipText: "{name}: {value}",
          interactive: true,
          stroke: am5.color(0xffffff),
          strokeWidth: 0.5
        });

        // ìƒ‰ìƒ ì„¤ì •
        polygonSeries.set("heatRules", [{
          target: polygonSeries.mapPolygons.template,
          dataField: "value",
          key: "fill",
          min: am5.color(0xd6eaf8),
          max: am5.color(0x1f618d)
        }]);

        // ì§€ë„ ë°ì´í„° ì„¸íŒ…
        polygonSeries.data.setAll(
          Object.entries(debutData).map(([id, value]) => ({ id, value }))
        );

        // hover ìƒ‰ìƒ
        polygonSeries.mapPolygons.template.states.create("hover", {
          fill: am5.color(0x21618c)
        });

        // í´ë¦­ ì´ë²¤íŠ¸
        polygonSeries.mapPolygons.template.events.on("click", function(ev) {
          const id = ev.target.dataItem.dataContext.id;
          const name = ev.target.dataItem.dataContext.name;
          if (debutData[id]) updateDetail(id, name);
        });

        // ë°ì´í„° ì—†ëŠ” êµ­ê°€ëŠ” íšŒìƒ‰ ë¹„í™œì„± ì²˜ë¦¬
        polygonSeries.mapPolygons.template.adapters.add("fill", (fill, target) => {
          const id = target.dataItem?.dataContext?.id;
          if (!debutData[id]) {
            target.set("interactive", false);
            return am5.color(0xe0e0e0);
          }
          return fill;
        });
      });
    }

    function updateDetail(countryId, name) {
      document.getElementById("countryName").innerText = name;
      const countryData = detailData[countryId];
      const noDataDiv = document.getElementById("noData");
      const canvas = document.getElementById("lineChart");

      if (!countryData) {
        canvas.style.display = "none";
        noDataDiv.style.display = "block";
        return;
      }

      noDataDiv.style.display = "none";
      canvas.style.display = "block";

      const years = Object.keys(Object.values(countryData)[0]);
      const datasets = Object.entries(countryData).map(([agency, values]) => ({
        label: agency,
        data: Object.values(values),
        borderWidth: 2,
        tension: 0.3
      }));

      if (window.currentChart) window.currentChart.destroy();
      window.currentChart = new Chart(canvas, {
        type: "line",
        data: { labels: years, datasets },
        options: {
          responsive: true,
          plugins: { legend: { position: "bottom" } },
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    }

    loadData();
  </script>
</body>
</html>