<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>K-pop ì•„ì´ëŒ ëŒ€ì‹œë³´ë“œ</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="../static/debut_data.js"></script>
  <style>
    body {
      background: #f8f9fa;
      color: #212529; 
      font-family: 'Noto Sans KR', sans-serif;
      margin: 0;
      padding: 50px 0;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .dashboard {
      width: 1200px;
      background: #ffffff; 
      border-radius: 18px;
      box-shadow: 0 6px 25px rgba(0, 0, 0, 0.5);
      padding: 40px;
      margin-bottom: 40px;
    }

    .row {
      display: flex;
      justify-content: space-between;
      gap: 40px;
    }

    .chart-box {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    canvas {
      width: 100%;
      height: 400px;
    }

    #trendChart {
      height: 500px; /* ì™¼ìª½ ê·¸ë˜í”„ ë†’ì´ í™•ëŒ€ */
    }

    .empty-box {
      flex: 1;
      height: 400px;
      background: #f0f0f0;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #6c757d;
      font-size: 18px;
    }
    .chart-box {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
  justify-content: flex-start; /* ì¶”ê°€ */
}
    .project-title {
      width: 1300px;
      text-align: center;
      background: linear-gradient(80deg, #a18cd1 0%, #fbc2eb 100%);
      color: #ffffff;
      font-size: 15px;
      font-weight: 500;
      padding: 4px 0;
      border-radius: 14px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.25);
      letter-spacing: 1px;
      margin-bottom: 30px;
      font-family: 'Noto Sans KR', sans-serif;
    }

  </style>
</head>
<body>

  <div class="project-title">
    <h1>ì•„ì´ëŒ êµ­ì  ë°ì´í„°ë¡œ ë³¸ K-POP ê¸€ë¡œë²Œë¼ì´ì œì´ì…˜</h1>
  </div>

  <!-- ìƒë‹¨: ì£¼ìš” ê·¸ë˜í”„ -->
  <div class="dashboard">
    <div class="row">
      <!-- ì™¼ìª½: ë°ë·” ìˆ˜ + ì´ë™í‰ê·  -->
      <div class="chart-box">
        <canvas id="trendChart"></canvas>
        <canvas id="foreignRatioChart" style="margin-top:40px;"></canvas>
      </div>

      <!-- ì˜¤ë¥¸ìª½: êµ­ì  ë¹„ìœ¨ -->
      <div class="chart-box">
        <canvas id="nationalityChart"></canvas>
      </div>
    </div>
  </div>

  <!-- í•˜ë‹¨: í™•ì¥ìš© ëŒ€ì‹œë³´ë“œ (ê³µë°±) -->
  <div class="dashboard">
    <div class="row">
      <div class="empty-box">ğŸ“¦ ì¤€ë¹„ ì¤‘ (ì™¼ìª½ ì˜ì—­)</div>
      <div class="empty-box">ğŸ“¦ ì¤€ë¹„ ì¤‘ (ì˜¤ë¥¸ìª½ ì˜ì—­)</div>
    </div>
  </div>

  <script>
    // ======= ë°ì´í„° ë¡œë“œ =======
    const data = debutData;

    // ======= í•„ë“œëª… ë³´ì • =======
    data.forEach(d => {
      d.year = d.year || d.debut_year || d.active_year;
      d.nationality = d.nationality || d.country || d.birth_country;
    });

    // ======= ì—°ë„ë³„ ë°ë·” ì•„ì´ëŒ ìˆ˜ + ì´ë™í‰ê·  =======
    const yearCount = {};
    data.forEach(d => {
      const year = parseInt(d.year);
      if (isNaN(year) || year < 2005) return;
      yearCount[year] = (yearCount[year] || 0) + 1;
    });

    const years = Object.keys(yearCount).map(Number).sort((a, b) => a - b);
    const counts = years.map(y => yearCount[y]);
    const movingAvg = counts.map((_, i, arr) => {
      const slice = arr.slice(Math.max(0, i - 2), i + 1);
      const avg = slice.reduce((a, b) => a + b, 0) / slice.length;
      return avg.toFixed(2);
    });

    // ======= ì™¸êµ­ì¸ ì•„ì´ëŒ ë¹„ìœ¨ =======
    const foreignRatio = {};
    years.forEach(y => {
      const all = data.filter(d => parseInt(d.year) === y);
      const foreign = all.filter(d => {
        const nat = d.nationality?.toLowerCase() || '';
        return !['korea', 'south korea', 'ëŒ€í•œë¯¼êµ­', 'í•œêµ­', 'korean'].some(k => nat.includes(k));
      });
      foreignRatio[y] = all.length ? (foreign.length / all.length * 100).toFixed(2) : 0;
    });

    const ratioValues = years.map(y => foreignRatio[y]);

    // ======= ì™¸êµ­ì¸ ì•„ì´ëŒ êµ­ì  ë¹„ìœ¨ TOP10 =======
    const nationalityCount = {};
    data.forEach(d => {
      if (!d.nationality) return;
      const nat = d.nationality.toString().trim().toLowerCase();
      if (['korea', 'south korea', 'republic of korea', 'ëŒ€í•œë¯¼êµ­', 'í•œêµ­', 'korean'].some(k => nat.includes(k))) return;
      nationalityCount[nat] = (nationalityCount[nat] || 0) + 1;
    });

    const top10 = Object.entries(nationalityCount)
      .sort((a, b) => b[1] - a[1])
      .slice(0, 10);

    // ======= êµ­ê°€ëª… í•œêµ­ì–´ ë³€í™˜ =======
    const countryNames = {
      'china': 'ì¤‘êµ­', 'japan': 'ì¼ë³¸', 'thailand': 'íƒœêµ­', 'usa': 'ë¯¸êµ­',
      'taiwan': 'ëŒ€ë§Œ', 'australia': 'í˜¸ì£¼', 'canada': 'ìºë‚˜ë‹¤', 'vietnam': 'ë² íŠ¸ë‚¨',
      'indonesia': 'ì¸ë„ë„¤ì‹œì•„', 'philippines': 'í•„ë¦¬í•€', 'malaysia': 'ë§ë ˆì´ì‹œì•„',
      'mongolia': 'ëª½ê³¨', 'hong kong': 'í™ì½©', 'singapore': 'ì‹±ê°€í¬ë¥´', 'uk': 'ì˜êµ­',
      'france': 'í”„ë‘ìŠ¤', 'germany': 'ë…ì¼'
    };

    const nationalLabels = top10.map(([k]) => countryNames[k] || k);
    const nationalValues = top10.map(([, v]) => v);

    // ======= Chart.js =======

    // (1) ì—°ë„ë³„ ë°ë·” ì•„ì´ëŒ ìˆ˜ + ì´ë™í‰ê· 
    new Chart(document.getElementById('trendChart'), {
      type: 'bar',
      data: {
        labels: years,
        datasets: [
          {
            label: 'ë°ë·” ì•„ì´ëŒ ìˆ˜',
            data: counts,
            backgroundColor: 'rgba(54, 162, 235, 0.8)',
            borderWidth: 0
          },
          {
            label: '3ë…„ ì´ë™í‰ê· ',
            data: movingAvg,
            type: 'line',
            borderColor: '#ff6b81',
            borderWidth: 3,
            pointRadius: 4,
            fill: false,
            tension: 0.3
          }
        ]
      },
      options: {
        plugins: {
          legend: { labels: { color: '#212529' } },
          title: {
            display: true,
            text: 'ì—°ë„ë³„ ë°ë·” ì•„ì´ëŒ ìˆ˜ & 3ë…„ ì´ë™í‰ê·  (2005~)',
            color: '#6a78ee',
            font: { size: 18 }
          }
        },
        scales: {
          x: { ticks: { color: '#ccc' }, title: { display: true, text: 'ì—°ë„', color: '#aaa' } },
          y: { ticks: { color: '#ccc' }, title: { display: true, text: 'ì•„ì´ëŒ ìˆ˜', color: '#aaa' }, beginAtZero: true }
        }
      }
    });

     new Chart(document.getElementById('foreignRatioChart'), {
    type: 'line',
    data: {
      labels: years.filter(y => y >= 2009),
      datasets: [{
        label: 'ì™¸êµ­ì¸ ë¹„ìœ¨ (%)',
        data: ratioValues.filter((_, i) => years[i] >= 2009),
        borderColor: '#ffcd56',
        backgroundColor: 'rgba(255, 205, 86, 0.2)',
        borderWidth: 3,
        pointRadius: 4,
        fill: true,
        tension: 0.3
      }]
    },
    options: {
      plugins: {
        legend: { position: 'top', labels: { color: '#212529' } },
        title: {
          display: true,
          text: 'ì—°ë„ë³„ ì™¸êµ­ì¸ ì•„ì´ëŒ ë¹„ìœ¨ ë³€í™” (2009ë…„ ì´í›„)',
          color: '#6a78ee',
          font: { size: 18 }
        }
      },
      scales: {
        x: {
          ticks: { color: '#ccc' },
          title: { display: true, text: 'ì—°ë„', color: '#aaa' }
        },
        y: {
          ticks: { color: '#ccc', stepSize: 2 },
          title: { display: true, text: 'ì™¸êµ­ì¸ ë¹„ìœ¨ (%)', color: '#aaa' },
          beginAtZero: true,
          max: 24   // âœ… ìµœëŒ€ê°’ 20%ë¡œ ì„¤ì •
        }
      }
    }
  });

 // (3) ì™¸êµ­ì¸ ì•„ì´ëŒ êµ­ì  ë¹„ìœ¨ TOP10 (ìƒìœ„ 5ê°œ ë‚´ë¶€ + ì•„ë˜ì— ì „ì²´ ë²”ë¡€)
new Chart(document.getElementById('nationalityChart'), {
  type: 'doughnut',
  data: {
    labels: nationalLabels,
    datasets: [{
      data: nationalValues,
      backgroundColor: [
        '#ff6384','#36a2eb','#ffce56','#4bc0c0','#9966ff',
        '#ff9f40','#c9cbcf','#f77825','#00a896','#f94144'
      ],
      borderWidth: 2,
      hoverOffset: 0
    }]
  },
  options: {
    cutout: '35%',
    plugins: {
      tooltip: { enabled: false },
      title: {
        display: true,
        text: 'ì™¸êµ­ì¸ ì•„ì´ëŒ êµ­ì  ë¹„ìœ¨ TOP 10 (í•œêµ­ ì œì™¸)',
        color: '#6a78ee',
        font: { size: 18 }
      },
      legend: {
        display: true,
        position: 'bottom',
        labels: {
        color: '#212529',
        font: { size: 14, family: 'Noto Sans KR'},
        padding: 20,
        generateLabels: function(chart) {
        const data = chart.data;
        const total = data.datasets[0].data.reduce((a, b) => a + b, 0);

        // í•œêµ­ì–´ ë³€í™˜
        const countryNames = {
          'china': 'ì¤‘êµ­', 'japan': 'ì¼ë³¸', 'thailand': 'íƒœêµ­', 'usa': 'ë¯¸êµ­',
          'taiwan': 'ëŒ€ë§Œ', 'australia': 'í˜¸ì£¼', 'canada': 'ìºë‚˜ë‹¤', 'vietnam': 'ë² íŠ¸ë‚¨',
          'indonesia': 'ì¸ë„ë„¤ì‹œì•„', 'philippines': 'í•„ë¦¬í•€', 'malaysia': 'ë§ë ˆì´ì‹œì•„',
          'mongolia': 'ëª½ê³¨', 'hong kong': 'í™ì½©', 'singapore': 'ì‹±ê°€í¬ë¥´', 'uk': 'ì˜êµ­',
          'france': 'í”„ë‘ìŠ¤', 'germany': 'ë…ì¼'
        };

        // âœ… í˜¸ì£¼ë¶€í„° ë…ì¼ê¹Œì§€ë§Œ í‘œì‹œ (6~10ë²ˆì§¸)
        const start = 5; // 6ë²ˆì§¸(í˜¸ì£¼)ë¶€í„°
        const end = 10;  // 10ë²ˆì§¸(ë…ì¼)ê¹Œì§€

        return data.labels.slice(start, end).map((label, i) => ({
          text: `${countryNames[label.toLowerCase()] || label} (${((data.datasets[0].data[i + start] / total) * 100).toFixed(1)}%)`,
          fillStyle: data.datasets[0].backgroundColor[i + start],
          strokeStyle: data.datasets[0].backgroundColor[i + start],
          lineWidth: 2,
          hidden: false,
          index: i + start
            }));
          }
        },
        onClick: (e, legendItem, legend) => {
        // ì•„ë¬´ê²ƒë„ ì•ˆ í•´ì„œ í† ê¸€ ë™ì‘ ë§‰ê¸°
        e.stopPropagation();
      },
    }
    },
  },
  plugins: [{
    id: 'labelInside',
    afterDatasetsDraw(chart) {
      const { ctx } = chart;
      const meta = chart.getDatasetMeta(0);
      const dataset = chart.data.datasets[0];
      const total = dataset.data.reduce((a, b) => a + b, 0);
      const top5 = meta.data.slice(0, 5);

      // ===== ìƒìœ„ 5ê°œ ë„ë„› ë‚´ë¶€ í‘œì‹œ =====
      ctx.save();
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      top5.forEach((arc, i) => {
        const { x, y } = arc.tooltipPosition();
        const label = chart.data.labels[i];
        const value = dataset.data[i];
        const percent = ((value / total) * 100).toFixed(1) + '%';
        ctx.font = '18px "Noto Sans KR"';
        ctx.fillStyle = '#fff';
        ctx.fillText(label, x, y - 10);
        ctx.font = '13px "Noto Sans KR"';
        ctx.fillStyle = '#fff';
        ctx.fillText(percent, x, y + 12);
      });
      ctx.restore();
    }
  }]
});

  </script>
</body>
</html>
